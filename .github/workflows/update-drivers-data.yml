name: Update LOLDrivers Data

# ExÃ©cution programmÃ©e : tous les mardis Ã  06:00 UTC
on:
  schedule:
    - cron: '0 6 * * 2'  # Chaque mardi Ã  6h UTC
  workflow_dispatch:  # Permet d'exÃ©cuter manuellement

permissions:
  contents: write
  actions: read
  pull-requests: write
  metadata: read
  
env:
  REMOTE_URL: https://raw.githubusercontent.com/magicsword-io/LOLDrivers/refs/heads/main/loldrivers.io/content/api/drivers.json
  LOCAL_FILE: data/drv.json

jobs:
  update-drivers-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        persist-credentials: true
        
    - name: ðŸ” Download remote file for comparison
      id: download
      run: |
        echo "ðŸ“¡ Downloading remote drivers.json..."
        curl -s -L "$REMOTE_URL" -o temp_drivers.json
        
        if [ ! -f temp_drivers.json ]; then
          echo "âŒ Failed to download remote file"
          exit 1
        fi
        
        echo "âœ… Remote file downloaded successfully"
        echo "ðŸ“Š Remote file size: $(stat -c%s temp_drivers.json) bytes"
        
    - name: ðŸ“‹ Compare files
      id: compare
      run: |
        if [ ! -f "$LOCAL_FILE" ]; then
          echo "ðŸ†• Local file doesn't exist, will create it"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "change_type=new_file" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "ðŸ” Comparing files..."
        echo "ðŸ“Š Local file size: $(stat -c%s $LOCAL_FILE) bytes"
        echo "ðŸ“Š Remote file size: $(stat -c%s temp_drivers.json) bytes"
        
        # Comparaison des hash MD5
        local_hash=$(md5sum "$LOCAL_FILE" | cut -d' ' -f1)
        remote_hash=$(md5sum temp_drivers.json | cut -d' ' -f1)
        
        echo "ðŸ” Local MD5: $local_hash"
        echo "ðŸ” Remote MD5: $remote_hash"
        
        if [ "$local_hash" != "$remote_hash" ]; then
          echo "ðŸ”„ Files are different - update needed"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "change_type=updated" >> $GITHUB_OUTPUT
          
          # Analyse des changements JSON (optionnel)
          if command -v jq &> /dev/null; then
            local_count=$(jq '. | length' "$LOCAL_FILE" 2>/dev/null || echo "unknown")
            remote_count=$(jq '. | length' temp_drivers.json 2>/dev/null || echo "unknown")
            echo "ðŸ“ˆ Local entries: $local_count"
            echo "ðŸ“ˆ Remote entries: $remote_count"
            echo "local_count=$local_count" >> $GITHUB_OUTPUT
            echo "remote_count=$remote_count" >> $GITHUB_OUTPUT
          fi
        else
          echo "âœ… Files are identical - no update needed"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: ðŸ”„ Update local file
      if: steps.compare.outputs.has_changes == 'true'
      run: |
        echo "ðŸ“ Updating local file..."
        
        # CrÃ©er le rÃ©pertoire data s'il n'existe pas
        mkdir -p data
        
        # Remplacer le fichier local
        mv temp_drivers.json "$LOCAL_FILE"
        
        echo "âœ… Local file updated successfully"
        echo "ðŸ“Š New file size: $(stat -c%s $LOCAL_FILE) bytes"
        
    - name: ðŸ“„ Generate update summary
      if: steps.compare.outputs.has_changes == 'true'
      id: summary
      run: |
        echo "ðŸ“‹ Generating update summary..."
        
        # CrÃ©er un rÃ©sumÃ© des changements
        summary="## ðŸ”„ LOLDrivers Data Update\n\n"
        summary+="**Update Type:** ${{ steps.compare.outputs.change_type }}\n"
        summary+="**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')\n"
        summary+="**Source:** [LOLDrivers GitHub](https://github.com/magicsword-io/LOLDrivers)\n\n"
        
        if [ "${{ steps.compare.outputs.change_type }}" = "updated" ]; then
          summary+="### ðŸ“Š Statistics\n"
          summary+="- **Local entries:** ${{ steps.compare.outputs.local_count }}\n"
          summary+="- **Remote entries:** ${{ steps.compare.outputs.remote_count }}\n\n"
          
          # Calculer la diffÃ©rence si possible
          if [[ "${{ steps.compare.outputs.local_count }}" =~ ^[0-9]+$ ]] && [[ "${{ steps.compare.outputs.remote_count }}" =~ ^[0-9]+$ ]]; then
            diff=$((${{ steps.compare.outputs.remote_count }} - ${{ steps.compare.outputs.local_count }}))
            if [ $diff -gt 0 ]; then
              summary+="- **New entries:** +$diff ðŸ“ˆ\n"
            elif [ $diff -lt 0 ]; then
              summary+="- **Removed entries:** $diff ðŸ“‰\n"
            else
              summary+="- **No change in count** (content updated) ðŸ”„\n"
            fi
          fi
        fi
        
        summary+="### ðŸ”— Links\n"
        summary+="- [View Updated File](./data/drv.json)\n"
        summary+="- [LOLDrivers Website](https://loldrivers.io/)\n"
        summary+="- [Source Repository](https://github.com/magicsword-io/LOLDrivers)\n"
        
        # Sauvegarder pour le commit message
        echo -e "$summary" > update_summary.md
        echo "summary_created=true" >> $GITHUB_OUTPUT
        
    - name: ðŸš€ Commit and push changes
      if: steps.compare.outputs.has_changes == 'true'
      run: |
        echo "ðŸ”§ Configuring git..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - LOLDrivers Updater"
        
        echo "ðŸ“ Adding changes..."
        git add "$LOCAL_FILE"
        
        # Message de commit avec rÃ©sumÃ©
        if [ "${{ steps.compare.outputs.change_type }}" = "new_file" ]; then
          commit_msg="ðŸ†• Add initial LOLDrivers data file"
        else
          commit_msg="ðŸ”„ Update LOLDrivers data"
          if [[ "${{ steps.compare.outputs.local_count }}" =~ ^[0-9]+$ ]] && [[ "${{ steps.compare.outputs.remote_count }}" =~ ^[0-9]+$ ]]; then
            diff=$((${{ steps.compare.outputs.remote_count }} - ${{ steps.compare.outputs.local_count }}))
            if [ $diff -gt 0 ]; then
              commit_msg+=": +$diff new entries"
            elif [ $diff -lt 0 ]; then
              commit_msg+=": $diff entries removed"
            else
              commit_msg+=": content updated"
            fi
          fi
        fi
        
        commit_msg+="\n\nAutomated update from LOLDrivers repository"
        commit_msg+="\nSource: $REMOTE_URL"
        commit_msg+="\nTimestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        echo "ðŸ’¾ Committing changes..."
        git commit -m "$commit_msg"
        
        echo "ðŸš€ Pushing to repository..."
        git push origin ${{ github.ref_name }}
        
        echo "âœ… Changes pushed successfully!"
        
    - name: ðŸ§¹ Cleanup temporary files
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up temporary files..."
        rm -f temp_drivers.json update_summary.md
        echo "âœ… Cleanup completed"
        
    - name: ðŸ“Š Job Summary
      if: always()
      run: |
        echo "## ðŸ“‹ Job Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow:** Update LOLDrivers Data" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.compare.outputs.has_changes }}" = "true" ]; then
          echo "- **Result:** âœ… Data updated successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **Change Type:** ${{ steps.compare.outputs.change_type }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Result:** â„¹ï¸ No changes detected" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Resources" >> $GITHUB_STEP_SUMMARY
        echo "- [LOLDrivers Website](https://loldrivers.io/)" >> $GITHUB_STEP_SUMMARY
        echo "- [Source Repository](https://github.com/magicsword-io/LOLDrivers)" >> $GITHUB_STEP_SUMMARY
        echo "- [Data File]($REMOTE_URL)" >> $GITHUB_STEP_SUMMARY
